<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Optimizing the setup - SE202 : Rust pour les systèmes embarqués</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../intro.html">Introduction</a></li><li class="chapter-item expanded "><a href="../../labs/fibo.html"><strong aria-hidden="true">1.</strong> Prise en main : Fibonacci</a></li><li class="chapter-item expanded "><a href="../../labs/vm/machine.html"><strong aria-hidden="true">2.</strong> A virtual machine in Rust</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../labs/vm/specs.html"><strong aria-hidden="true">2.1.</strong> Specifications</a></li></ol></li><li class="chapter-item expanded "><a href="../../problems/problems.html"><strong aria-hidden="true">3.</strong> A few simple problems</a></li><li class="chapter-item expanded "><a href="../../labs/led-matrix/led-matrix.html"><strong aria-hidden="true">4.</strong> LED matrix lab</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../labs/led-matrix/setup.html"><strong aria-hidden="true">4.1.</strong> Initial setup</a></li><li class="chapter-item expanded "><a href="../../labs/led-matrix/structures.html"><strong aria-hidden="true">4.2.</strong> Visual data structures</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../labs/led-matrix/color.html"><strong aria-hidden="true">4.2.1.</strong> Color</a></li><li class="chapter-item expanded "><a href="../../labs/led-matrix/image.html"><strong aria-hidden="true">4.2.2.</strong> Image</a></li><li class="chapter-item expanded "><a href="../../labs/led-matrix/reexport.html"><strong aria-hidden="true">4.2.3.</strong> Reexporting types</a></li></ol></li><li class="chapter-item expanded "><a href="../../labs/led-matrix/embedded.html"><strong aria-hidden="true">4.3.</strong> Embedded mode</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../labs/led-matrix/toolchain.html"><strong aria-hidden="true">4.3.1.</strong> Configuring the toolchain</a></li><li class="chapter-item expanded "><a href="../../labs/led-matrix/uploading.html"><strong aria-hidden="true">4.3.2.</strong> Uploading the program onto the board</a></li><li class="chapter-item expanded "><a href="../../labs/led-matrix/execution.html"><strong aria-hidden="true">4.3.3.</strong> Displaying something</a></li><li class="chapter-item expanded "><a href="../../labs/led-matrix/optimize-setup.html" class="active"><strong aria-hidden="true">4.3.4.</strong> Optimizing the setup</a></li><li class="chapter-item expanded "><a href="../../labs/led-matrix/hal.html"><strong aria-hidden="true">4.3.5.</strong> Configuring the hardware</a></li><li class="chapter-item expanded "><a href="../../labs/led-matrix/matrix.html"><strong aria-hidden="true">4.3.6.</strong> GPIO and the LED matrix</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../labs/led-matrix/real-time.html"><strong aria-hidden="true">5.</strong> Real-time mode</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../labs/led-matrix/rtic.html"><strong aria-hidden="true">5.1.</strong> RTIC</a></li><li class="chapter-item expanded "><a href="../../labs/led-matrix/timer.html"><strong aria-hidden="true">5.2.</strong> Monotonic timer</a></li><li class="chapter-item expanded "><a href="../../labs/led-matrix/image-change.html"><strong aria-hidden="true">5.3.</strong> Image change</a></li><li class="chapter-item expanded "><a href="../../labs/led-matrix/serial.html"><strong aria-hidden="true">5.4.</strong> Serial port</a></li><li class="chapter-item expanded "><a href="../../labs/led-matrix/triple-buffering.html"><strong aria-hidden="true">5.5.</strong> Triple buffering</a></li><li class="chapter-item expanded "><a href="../../labs/led-matrix/screen-saver.html"><strong aria-hidden="true">5.6.</strong> Screen saver</a></li><li class="chapter-item expanded "><a href="../../labs/led-matrix/drawing.html"><strong aria-hidden="true">5.7.</strong> Drawing things</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">SE202 : Rust pour les systèmes embarqués</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="optimizing-the-setup"><a class="header" href="#optimizing-the-setup">Optimizing the setup</a></h1>
<p>We will take some steps to ease our development process and save some time later.</p>
<h2 id="reduce-binary-size"><a class="header" href="#reduce-binary-size">Reduce binary size</a></h2>
<p>Using <code>cargo size</code> and <code>cargo size --release</code>, we can see that the binary produced in release mode is much smaller than the one produced in debug mode. Note that <code>size</code> doesn't display the debug information since those are never stored in the target memory.</p>
<p>We would like to use <code>--release</code> to keep an optimized binary, but we would like to keep the debug information in case we need to use <code>gdb</code>, or to have a better backtrace in case of panic. Fortunately,
we can do that with <code>cargo</code> and require that the <code>release</code> profile:</p>
<ul>
<li>keeps debug symbols;</li>
<li>uses <a href="https://en.wikipedia.org/wiki/Interprocedural_optimization">link-time-optimization (LTO)</a> to optimize the produced binary even further;</li>
<li>generates objects one by one to get an even better optimization.</li>
</ul>
<p>❎ To do so, add the following section to your program <code>Cargo.toml</code>:</p>
<pre><code class="language-toml">[profile.release]
debug = true      # symbols are nice and they don't increase the size on the target
lto = true        # better optimizations
codegen-units = 1 # better optimizations
</code></pre>
<p>From now on, we will always use <code>--release</code> when building binaries and those will be optimized fully and contain debugging symbols.</p>
<h2 id="make-it-simplier-to-run-the-program"><a class="header" href="#make-it-simplier-to-run-the-program">Make it simplier to run the program</a></h2>
<p>Even though we have configured <code>cargo run</code> so that it runs <code>gdb</code> automatically and uploads our program, we still have to start <code>JLinkGDBServer</code> and <code>JLinkRTTClient</code>. Fortunately, the <a href="https://github.com/probe-rs/probe-rs"><code>probe-rs</code></a> and <code>knurling-rs</code> projects make it easy to develop embedded Rust programs:</p>
<ul>
<li><code>probe-rs-cli</code> lets you manipulate the probes connected to your computer, such as the probe located on your IoT-node board.</li>
<li><code>probe-run</code> lets you run your compiled program and uses RTT to get information.</li>
<li><code>defmt</code> (for <em>deferred formatting</em>) is a logging library and set of tools that lets you log events from your embedded programs and transmit them in an efficient binary format. The formatting for the developer consumption will be made by tools running on the host rather than on the target. <code>probe-run</code> is able to get <code>defmt</code> traces using a RTT channel and decode and format them.</li>
</ul>
<p>Many others programs such as <code>cargo flash</code> or <code>cargo embed</code> exist, but we will not need them here.</p>
<p>❎ Stop the Segger JLink tools. Using the <code>probe-rs-cli</code> executable, check if the probe on your board is properly detected.</p>
<p>❎ Use <code>probe-run</code> with the appropriate parameters instead of <code>gdb</code> to upload your program onto the board and run it. Replace your runner in <code>.cargo/config.toml</code> by:</p>
<pre><code class="language-toml">runner = &quot;probe-run --chip stm32l475vg&quot;
</code></pre>
<p>❎ Using <code>cargo run --release</code>, look at your program being compiled, uploaded and run on your board. You should see the messages sent over RTT on your screen.</p>
<p>⚠ You can use <code>ctrl-c</code> to quit <code>probe-run</code>.</p>
<h2 id="use-defmt-for-logging"><a class="header" href="#use-defmt-for-logging">Use defmt for logging</a></h2>
<p>Instead of using RTT directly, we will use <code>defmt</code> to have a better and efficient logging system.</p>
<p>❎ Remove the <code>rtt-target</code> and <code>panic-rtt-target</code> from your dependencies in <code>Cargo.toml</code>.</p>
<p>❎ Add the <code>defmt</code> and <code>defmt-rtt</code> dependencies to your <code>Cargo.toml</code>.</p>
<p>❎ Add the <code>panic-probe</code> dependency to your <code>Cargo.toml</code> with the <code>print-defmt</code> feature.</p>
<p><code>defmt-rtt</code> is the RTT transport library for <code>defmt</code>. <code>panic-probe</code> with the <code>print-defmt</code> feature will indicate to <code>probe-run</code> the panic message to display using defmt and will tell it to stop in case of a panic.</p>
<p>❎ <code>defmt</code> uses a special section in your executable. In <code>.cargo/config.toml</code>, add the following to your existing <code>rustflags</code> in order to include the provided linker file fragment: <code>&quot;-C&quot;, &quot;link-arg=-Tdefmt.x&quot;</code>.</p>
<p>❎ Modify your code in <code>src/main.rs</code> to include the following changes:</p>
<ul>
<li>Write <code>use panic_probe as _;</code> instead of <code>panic_rtt_target</code> to use the <code>panic-probe</code> crate.</li>
<li>Write <code>use defmt_rtt as _;</code> to link with the <code>defmtt-rtt</code> library.</li>
<li>Remove use of <code>rtt_target</code> items.</li>
<li>Remove <code>rtt_init_print!()</code>, and replace <code>rprintln!()</code> with <code>defmt::info!()</code> to print a message.</li>
</ul>
<p>❎ Run your program using <code>cargo run --release</code>. Notice that you see the panic information, but you do not see the &quot;Hello, world!&quot; message.</p>
<p>By default, <code>defmt</code> only prints errors. The various log level are <code>trace</code>, <code>debug</code>, <code>info</code>, <code>warn</code>, and <code>error</code>. If you want to see the messages of level <code>info</code> and above (<code>info</code>, <code>warn</code>, and <code>error</code>), you must set the <code>DEFMT_LOG</code> environment variable when building and when running the program. Only the appropriate information will be included at build time and displayed at run time.</p>
<p>❎ Build and run your program using <code>DEFMT_LOG=info cargo run --release</code>. You will see the &quot;Hello, world!&quot; message. Note that you could also have used <code>DEFMT_LOG=trace</code> or <code>DEFMT_LOG=debug</code> since</p>
<p>🎉 Your environment is fully setup in an efficient way. If needed, you can revert to using <code>gdb</code> and Segger JLink tools, but that should be reserved to extreme cases.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../labs/led-matrix/execution.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../labs/led-matrix/hal.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../labs/led-matrix/execution.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../labs/led-matrix/hal.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
