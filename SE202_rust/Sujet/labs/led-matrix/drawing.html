<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Drawing things - SE202 : Rust pour les systèmes embarqués</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../intro.html">Introduction</a></li><li class="chapter-item expanded "><a href="../../labs/fibo.html"><strong aria-hidden="true">1.</strong> Prise en main : Fibonacci</a></li><li class="chapter-item expanded "><a href="../../labs/vm/machine.html"><strong aria-hidden="true">2.</strong> A virtual machine in Rust</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../labs/vm/specs.html"><strong aria-hidden="true">2.1.</strong> Specifications</a></li></ol></li><li class="chapter-item expanded "><a href="../../problems/problems.html"><strong aria-hidden="true">3.</strong> A few simple problems</a></li><li class="chapter-item expanded "><a href="../../labs/led-matrix/led-matrix.html"><strong aria-hidden="true">4.</strong> LED matrix lab</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../labs/led-matrix/setup.html"><strong aria-hidden="true">4.1.</strong> Initial setup</a></li><li class="chapter-item expanded "><a href="../../labs/led-matrix/structures.html"><strong aria-hidden="true">4.2.</strong> Visual data structures</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../labs/led-matrix/color.html"><strong aria-hidden="true">4.2.1.</strong> Color</a></li><li class="chapter-item expanded "><a href="../../labs/led-matrix/image.html"><strong aria-hidden="true">4.2.2.</strong> Image</a></li><li class="chapter-item expanded "><a href="../../labs/led-matrix/reexport.html"><strong aria-hidden="true">4.2.3.</strong> Reexporting types</a></li></ol></li><li class="chapter-item expanded "><a href="../../labs/led-matrix/embedded.html"><strong aria-hidden="true">4.3.</strong> Embedded mode</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../labs/led-matrix/toolchain.html"><strong aria-hidden="true">4.3.1.</strong> Configuring the toolchain</a></li><li class="chapter-item expanded "><a href="../../labs/led-matrix/uploading.html"><strong aria-hidden="true">4.3.2.</strong> Uploading the program onto the board</a></li><li class="chapter-item expanded "><a href="../../labs/led-matrix/execution.html"><strong aria-hidden="true">4.3.3.</strong> Displaying something</a></li><li class="chapter-item expanded "><a href="../../labs/led-matrix/optimize-setup.html"><strong aria-hidden="true">4.3.4.</strong> Optimizing the setup</a></li><li class="chapter-item expanded "><a href="../../labs/led-matrix/hal.html"><strong aria-hidden="true">4.3.5.</strong> Configuring the hardware</a></li><li class="chapter-item expanded "><a href="../../labs/led-matrix/matrix.html"><strong aria-hidden="true">4.3.6.</strong> GPIO and the LED matrix</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../labs/led-matrix/real-time.html"><strong aria-hidden="true">5.</strong> Real-time mode</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../labs/led-matrix/rtic.html"><strong aria-hidden="true">5.1.</strong> RTIC</a></li><li class="chapter-item expanded "><a href="../../labs/led-matrix/timer.html"><strong aria-hidden="true">5.2.</strong> Monotonic timer</a></li><li class="chapter-item expanded "><a href="../../labs/led-matrix/image-change.html"><strong aria-hidden="true">5.3.</strong> Image change</a></li><li class="chapter-item expanded "><a href="../../labs/led-matrix/serial.html"><strong aria-hidden="true">5.4.</strong> Serial port</a></li><li class="chapter-item expanded "><a href="../../labs/led-matrix/triple-buffering.html"><strong aria-hidden="true">5.5.</strong> Triple buffering</a></li><li class="chapter-item expanded "><a href="../../labs/led-matrix/screen-saver.html"><strong aria-hidden="true">5.6.</strong> Screen saver</a></li><li class="chapter-item expanded "><a href="../../labs/led-matrix/drawing.html" class="active"><strong aria-hidden="true">5.7.</strong> Drawing things</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">SE202 : Rust pour les systèmes embarqués</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="drawing-things"><a class="header" href="#drawing-things">Drawing things</a></h1>
<p>The screensaver feature was nice, but the screensaver could be more
entertaining. What if it could display scrolling text, such as &quot;This
Rust SE202 project will get me a good grade&quot;?</p>
<p>Fortunately, one crate can help you do that: <a href="https://crates.io/crates/embedded_graphics/">embedded-graphics</a>. Provided
you do the proper interfacing with your hardware, this crate will let
you draw all kind of shapes, and even display text.</p>
<h2 id="interfacing-with-your-hardware-the-embedded-module"><a class="header" href="#interfacing-with-your-hardware-the-embedded-module">Interfacing with your hardware: the <code>embedded</code> module</a></h2>
<p>You have already decoupled the logical representation of your LED
matrix (the <code>Image</code> type) from the physical one (the <code>Matrix</code>
type). This will be your job easier, as you will only have to
interface the <code>Image</code> type with the <code>embedded-graphics</code> crate: once
you have an <code>Image</code> you can display it on your hardware by putting it
into <code>next_image</code>.</p>
<p>❎ Create an <code>embedded</code> module in your library. This module will
contain anything needed to interface the drawing primitives of the
<code>embedded-graphics</code> crate with your <code>Image</code> type.</p>
<p>First you'll have to choose a pixel representation that
<code>embedded-graphics</code> can use and which is appropriate for your
display. Since you can already display RGB colors with 8 bits data for
each component, the
<a href="https://docs.rs/embedded-graphics/latest/embedded_graphics/pixelcolor/struct.Rgb888.html"><code>Rgb888</code></a>
color type seems appropriate.</p>
<p>❎ Implement <code>From&lt;Rgb888&gt;</code> for your <code>Color</code> type. That will be useful
when drawing on your <code>Image</code>, to build a proper <code>Color</code> value.</p>
<p>Now, you need to implement the
<a href="https://docs.rs/embedded-graphics/latest/embedded_graphics/draw_target/trait.DrawTarget.html"><code>DrawTarget</code></a>
trait for your <code>Image</code> type. This trait is the one which does the real
drawing. You will only implement the minimal functionality and use the
provided defaults for the rest.</p>
<p>❎ Implement <code>DrawTarget</code> for <code>Image</code>:</p>
<ul>
<li>The <code>Color</code> type will be <code>Rgb888</code>.</li>
<li>You can use
<a href="https://doc.rust-lang.org/std/convert/enum.Infallible.html"><code>Infallible</code></a>
as your <code>Error</code> type, because drawing into an <code>Image</code> never fails.</li>
<li>When you implement <code>draw_iter()</code>, make sure that you only set the
pixels whose coordinates belong to the image (<code>x</code> and <code>y</code> both in
<code>0..8</code>). This method can be called with a larger image, for example
a large text, and you will only display a portion of it.</li>
<li>If you need to convert a <code>Rgb888</code> into a <code>Color</code>, do not forget that
you can use <code>.into()</code> because you implemented <code>From&lt;Rgb888&gt; for Color</code>.</li>
</ul>
<h2 id="upgrading-the-screensaver"><a class="header" href="#upgrading-the-screensaver">Upgrading the screensaver</a></h2>
<p>You can now use the drawing primitives of <code>embedded-graphics</code> to
create images in your screensaver instead of using gradients.</p>
<p>❎ Modify your screensaver so that it creates intesting images using
the drawing primitives. Do not forget to clear the image before
drawing in it (you may create a new <code>clear()</code> method on <code>Image</code> if you
wish, filling it with black).</p>
<p>For example, you could add another local variable in addition to the
color index, such as a shape index, and draw a square, a triangle, a
circle, and a solid color. Ideally, those color and shape indices
would use cycle sizes which are coprime, to maximize the displayed
combinations.</p>
<p>When this works, commit and push your code.</p>
<h2 id="drawing-text"><a class="header" href="#drawing-text">Drawing text</a></h2>
<p>The next step is to display scrolling text from the screensaver. Yes,
that means forgetting about the shapes that you just designed, they
were used to familiarize yourself with the library.</p>
<p>A
<a href="https://docs.rs/embedded-graphics/latest/embedded_graphics/text/struct.Text.html"><code>Text</code></a>
object represents some text that can later been drawn into anything
implementing <code>DrawTarget</code> (such as an <code>Image</code>). It uses a character
style, which can be built using
<a href="https://docs.rs/embedded-graphics/latest/embedded_graphics/mono_font/struct.MonoTextStyle.html#method.new"><code>MonoTextStyle::new()</code></a>
from a font and a color. And the
<a href="https://crates.rs/crates/ibm437"><code>ibm437</code></a> crate provides a great
<a href="https://docs.rs/ibm437/latest/ibm437/constant.IBM437_8X8_REGULAR.html"><code>IBM437_8X8_REGULAR</code></a>
font which will be perfect for your LED matrix.</p>
<p>The idea is to call your screensaver every 60ms (instead of every
second) and to make some text scroll to the next position if no new
image has been received. To make the text scroll to the left, you will
position it as a negative <code>x</code> offset: since you display pixels whose
<code>x</code> is in <code>0..8</code>, decreasing the <code>x</code> position of the start of the text
will make it go left.</p>
<p>❎ Modify the <code>screensaver()</code> task so that it gets called every
60ms. You need a precise timing if you want the scrolling to be
pleasant.</p>
<p>❎ Modify the <code>screensaver()</code> task such that, when it wants to display something:</p>
<ul>
<li>A <code>Text</code> object is built with a text such as &quot;Hello SE202&quot;, and
placed at an <code>x</code> position whose value is kept in a <code>offset</code> local
variable. You can use the color you want, or make the color cycle.</li>
<li>The text is drawn into an image coming from the pool, and exchanged
with <code>next_image</code> (don't forget to return the previous one to the
pool if set).</li>
<li>Decrease the <code>offset</code> local variable, except if the end of the text
has reached the <code>0</code> <code>x</code> coordinate, in which case <code>offset</code> must be
reset to display the text again (find the appropriate value so that
it is nice for the eyes). Note: the <code>Text</code> object has methods to
check its bounding box (the smallest rectangle in which it fits).</li>
</ul>
<p>❎ Modify the <code>screensaver()</code> task so that if a new image has been
received on the serial port, the offset of the text is reset so that
next time the screensaver displays something it will start from the
beginning of the text.</p>
<p>Note: you might have to adapt your <code>DrawingText</code> trait implementation for
<code>Image</code>, for example if the text appears upside down.</p>
<p>Make it even prettier if you wish, commit, push.</p>
<p><strong>🦀 Congratulations, you have reached the end of this lab! 🦀</strong></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../labs/led-matrix/screen-saver.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../labs/led-matrix/screen-saver.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
